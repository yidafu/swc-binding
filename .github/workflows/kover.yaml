name: Measure coverage

on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²è®°å½•ä»¥è®¡ç®—è¦†ç›–ç‡å·®å¼‚
      
      - name: Set up Zig
        uses: goto-bus-stop/setup-zig@v2
      
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: 'x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu,x86_64-pc-windows-msvc,x86_64-apple-darwin,aarch64-apple-darwin'
      
      - name: Install system dependencies
        run: bash ./setup-ubuntu.sh
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
      
      - name: Set up Gradle
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: false
      
      - name: Run tests with coverage for swc-binding module
        run: ./gradlew :swc-binding:test :swc-binding:koverXmlReport --no-daemon
      
      - name: Verify coverage report exists
        run: |
          if [ ! -f "swc-binding/build/reports/kover/report.xml" ]; then
            echo "Error: Coverage report not found!"
            exit 1
          fi
          echo "Coverage report found at swc-binding/build/reports/kover/report.xml"
      
      - name: Add coverage report to PR
        id: kover
        uses: mi-kas/kover-report@v1
        with:
          path: |
            ${{ github.workspace }}/swc-binding/build/reports/kover/report.xml
          title: ğŸ“Š Code Coverage Report
          # ä½¿ç”¨ github.tokenï¼ˆå·²é€šè¿‡ permissions.pull-requests: write æˆæƒï¼‰
          # å¦‚éœ€ä½¿ç”¨è‡ªå®šä¹‰ tokenï¼Œå¯åœ¨ä»“åº“ Secrets ä¸­è®¾ç½® PR_TOKEN å¹¶æ›¿æ¢ä¸º ${{ secrets.PR_TOKEN }}
          token: ${{ secrets.PR_TOKEN || github.token }}
          update-comment: true
          min-coverage-overall: 80
          min-coverage-changed-files: 80
          coverage-counter-type: LINE
